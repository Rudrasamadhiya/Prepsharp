<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - View Exam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .main-content { padding: 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>View Exam</h4>
            <a href="../../manage-exams.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Exam Details</h5>
            </div>
            <div class="card-body" id="exam-details">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading exam details...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Questions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Question</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questions-list">
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading questions...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCtkee-Lv8lEMestaSVJxx7yvKB-lBygPQ",
            authDomain: "prepsharp-c91fd.firebaseapp.com",
            projectId: "prepsharp-c91fd",
            storageBucket: "prepsharp-c91fd.firebasestorage.app",
            messagingSenderId: "688294848433",
            appId: "1:688294848433:web:dd93fc6d61d62392473f90",
            measurementId: "G-LLJSLMXMNY"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', function() {
            loadExamDetails();
            loadQuestions();
        });

        function loadExamDetails() {
            if (!examId) {
                document.getElementById('exam-details').innerHTML = '<div class="alert alert-danger">No exam ID provided</div>';
                return;
            }

            db.collection("papers").doc(examId).get().then(doc => {
                if (doc.exists) {
                    const exam = doc.data();
                    document.getElementById('exam-details').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> ${exam.name || 'N/A'}</p>
                                <p><strong>Type:</strong> ${exam.type || 'N/A'}</p>
                                <p><strong>Year:</strong> ${exam.year || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(exam.status)}">${exam.status || 'Draft'}</span></p>
                                <p><strong>Questions:</strong> ${exam.questions?.length || 0}</p>
                                <p><strong>Created By:</strong> ${exam.createdBy || 'N/A'}</p>
                            </div>
                        </div>
                        ${exam.description ? `<p><strong>Description:</strong> ${exam.description}</p>` : ''}
                    `;
                } else {
                    document.getElementById('exam-details').innerHTML = '<div class="alert alert-danger">Exam not found</div>';
                }
            }).catch(error => {
                console.error('Error loading exam:', error);
                document.getElementById('exam-details').innerHTML = '<div class="alert alert-danger">Error loading exam details</div>';
            });
        }

        function loadQuestions() {
            db.collection("papers").doc(examId).collection("questions").get().then(snapshot => {
                const tbody = document.getElementById('questions-list');
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No questions found</td></tr>';
                    return;
                }

                let index = 1;
                snapshot.forEach(doc => {
                    const question = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index++}</td>
                        <td>${question.subject || 'N/A'}</td>
                        <td><span class="badge bg-info">${question.type || 'MCQ'}</span></td>
                        <td>${question.text ? question.text.substring(0, 100) + '...' : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteQuestion('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading questions:', error);
                document.getElementById('questions-list').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading questions</td></tr>';
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Published': return 'success';
                case 'Review': return 'warning';
                case 'Draft': return 'secondary';
                default: return 'secondary';
            }
        }

        function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                db.collection("papers").doc(examId).collection("questions").doc(questionId).delete().then(() => {
                    alert('Question deleted successfully');
                    loadQuestions();
                }).catch(error => {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question');
                });
            }
        }
    </script>
</body>
</html>