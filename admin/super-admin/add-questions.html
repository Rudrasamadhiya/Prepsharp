<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Add Questions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .main-content { padding: 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Add Questions</h4>
            <a href="../../manage-exams.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="add-question-form">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Question Type</label>
                            <select class="form-select" id="question-type" required>
                                <option value="mcq-single">Single Correct MCQ</option>
                                <option value="mcq-multiple">Multiple Correct MCQ</option>
                                <option value="numerical">Numerical</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Subject</label>
                            <select class="form-select" id="question-subject" required>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Mathematics">Mathematics</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Chapter</label>
                            <input type="text" class="form-control" id="question-chapter" placeholder="Enter chapter name" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control" id="question-text" rows="3" required></textarea>
                    </div>
                    <div id="mcq-options">
                        <div class="mb-3">
                            <label class="form-label">Option A</label>
                            <input type="text" class="form-control" id="option-a">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Option B</label>
                            <input type="text" class="form-control" id="option-b">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Option C</label>
                            <input type="text" class="form-control" id="option-c">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Option D</label>
                            <input type="text" class="form-control" id="option-d">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Correct Answer</label>
                            <select class="form-select" id="correct-answer">
                                <option value="0">Option A</option>
                                <option value="1">Option B</option>
                                <option value="2">Option C</option>
                                <option value="3">Option D</option>
                            </select>
                        </div>
                    </div>
                    <div id="numerical-answer" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Correct Answer</label>
                            <input type="number" class="form-control" id="numerical-value" step="0.01">
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Add Question
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCtkee-Lv8lEMestaSVJxx7yvKB-lBygPQ",
            authDomain: "prepsharp-c91fd.firebaseapp.com",
            projectId: "prepsharp-c91fd",
            storageBucket: "prepsharp-c91fd.firebasestorage.app",
            messagingSenderId: "688294848433",
            appId: "1:688294848433:web:dd93fc6d61d62392473f90",
            measurementId: "G-LLJSLMXMNY"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('examId');

        document.getElementById('question-type').addEventListener('change', function() {
            const type = this.value;
            if (type === 'numerical') {
                document.getElementById('mcq-options').style.display = 'none';
                document.getElementById('numerical-answer').style.display = 'block';
            } else {
                document.getElementById('mcq-options').style.display = 'block';
                document.getElementById('numerical-answer').style.display = 'none';
            }
        });

        document.getElementById('add-question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const questionData = {
                type: document.getElementById('question-type').value,
                subject: document.getElementById('question-subject').value,
                chapter: document.getElementById('question-chapter').value,
                text: document.getElementById('question-text').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (questionData.type === 'numerical') {
                questionData.answer = parseFloat(document.getElementById('numerical-value').value);
            } else {
                questionData.options = [
                    document.getElementById('option-a').value,
                    document.getElementById('option-b').value,
                    document.getElementById('option-c').value,
                    document.getElementById('option-d').value
                ];
                questionData.correctOption = parseInt(document.getElementById('correct-answer').value);
            }

            // Get exam details first
            db.collection("papers").doc(examId).get().then(examDoc => {
                if (examDoc.exists) {
                    const examData = examDoc.data();
                    const examType = examData.type || 'Unknown';
                    
                    // Add to papers collection (existing pattern)
                    db.collection("papers").doc(examId).collection("questions").add(questionData).then(docRef => {
                        // Also save to questions collection with new structure
                        const questionId = `${examId}-${Date.now()}`;
                        const chapter = questionData.chapter || 'General';
                        
                        db.collection("questions")
                          .doc(examType)
                          .collection(questionData.subject)
                          .doc(chapter)
                          .collection("items")
                          .doc(questionId)
                          .set({
                              ...questionData,
                              paperId: examId,
                              questionId: questionId,
                              examType: examType
                          });
                        
                        alert('Question added successfully');
                        document.getElementById('add-question-form').reset();
                    });
                }
            }).catch(error => {
                console.error('Error adding question:', error);
                alert('Error adding question');
            });
        });
    </script>
</body>
</html>