<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Edit Exam</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .main-content { padding: 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Edit Exam</h4>
            <a href="../../manage-exams.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="edit-exam-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Exam Name</label>
                            <input type="text" class="form-control" id="exam-name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Exam Type</label>
                            <select class="form-select" id="exam-type" required>
                                <option value="JEE Main">JEE Main</option>
                                <option value="JEE Advanced">JEE Advanced</option>
                                <option value="NEET">NEET</option>
                                <option value="Mock Test">Mock Test</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Year</label>
                            <input type="number" class="form-control" id="exam-year" min="2020" max="2030" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="exam-status">
                                <option value="Draft">Draft</option>
                                <option value="Review">Review</option>
                                <option value="Published">Published</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="exam-description" rows="3"></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCtkee-Lv8lEMestaSVJxx7yvKB-lBygPQ",
            authDomain: "prepsharp-c91fd.firebaseapp.com",
            projectId: "prepsharp-c91fd",
            storageBucket: "prepsharp-c91fd.firebasestorage.app",
            messagingSenderId: "688294848433",
            appId: "1:688294848433:web:dd93fc6d61d62392473f90",
            measurementId: "G-LLJSLMXMNY"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', loadExam);

        function loadExam() {
            if (!examId) {
                alert('No exam ID provided');
                window.location.href = '../../manage-exams.html';
                return;
            }

            db.collection("papers").doc(examId).get().then(doc => {
                if (doc.exists) {
                    const exam = doc.data();
                    document.getElementById('exam-name').value = exam.name || '';
                    document.getElementById('exam-type').value = exam.type || '';
                    document.getElementById('exam-year').value = exam.year || '';
                    document.getElementById('exam-status').value = exam.status || 'Draft';
                    document.getElementById('exam-description').value = exam.description || '';
                } else {
                    alert('Exam not found');
                    window.location.href = '../../manage-exams.html';
                }
            }).catch(error => {
                console.error('Error loading exam:', error);
                alert('Error loading exam');
            });
        }

        document.getElementById('edit-exam-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const examData = {
                name: document.getElementById('exam-name').value,
                type: document.getElementById('exam-type').value,
                year: parseInt(document.getElementById('exam-year').value),
                status: document.getElementById('exam-status').value,
                description: document.getElementById('exam-description').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("papers").doc(examId).update(examData).then(() => {
                // Also update all questions in the questions collection
                return db.collection("papers").doc(examId).collection("questions").get();
            }).then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    const questionData = doc.data();
                    if (questionData.subject && questionData.chapter) {
                        const globalQuestionId = `${examId}-${questionData.createdAt || Date.now()}`;
                        const questionRef = db.collection('questions')
                            .doc(examData.type)
                            .collection(questionData.subject)
                            .doc(questionData.chapter)
                            .collection('items')
                            .doc(globalQuestionId);
                        batch.set(questionRef, {
                            ...questionData,
                            paperId: examId,
                            questionId: globalQuestionId,
                            examType: examData.type
                        });
                    }
                });
                return batch.commit();
            }).then(() => {
                alert('Exam updated successfully');
                window.location.href = '../../manage-exams.html';
            }).catch(error => {
                console.error('Error updating exam:', error);
                alert('Error updating exam');
            });
        });
    </script>
</body>
</html>