<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>PrepSharp Exam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .exam-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Top blue strip */
        .top-strip {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Black strip below */
        .black-strip {
            background-color: #000;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .paper-indicator {
            color: #ffff00; /* Neon yellow */
            font-weight: bold;
        }
        
        .strip-buttons {
            display: flex;
            gap: 15px;
        }
        
        .strip-btn {
            color: white;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .strip-btn i {
            margin-right: 5px;
        }
        
        /* Main content area */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Container for left panel and its footer */
        .left-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Container for right panel and its footer */
        .right-container {
            width: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Left panel - Question display */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Section tabs strip */
        .sections-strip {
            background-color: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            overflow-x: auto;
        }
        
        .section-tab {
            padding: 10px 15px;
            cursor: pointer;
            color: #0066cc;
            border-right: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .section-tab.active {
            background-color: #0066cc;
            color: white;
        }
        
        /* Blue language strip */
        .language-strip {
            background-color: #0066cc;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
        }
        
        .language-selector select {
            margin-left: 8px;
            padding: 3px;
            border: 1px solid white;
            background-color: white;
        }
        
        /* Question area */
        .question-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: white;
        }
        
        .question-number {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .question-content {
            margin-bottom: 20px;
        }
        
        .question-text {
            margin-bottom: 15px;
        }
        
        .question-image {
            max-width: 100%;
            margin: 15px 0;
            text-align: center;
        }
        
        .question-image img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Options */
        .options {
            margin-left: 20px;
        }
        
        .option {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        .option-radio {
            margin-right: 10px;
            margin-top: 3px;
        }
        
        .option-label {
            display: flex;
            align-items: flex-start;
        }
        
        .option-letter {
            font-weight: bold;
            margin-right: 10px;
            min-width: 15px;
        }
        
        .option-text {
            flex-grow: 1;
        }
        
        .option-image {
            max-width: 100%;
            margin-top: 5px;
        }
        
        .option-image img {
            max-width: 100%;
            max-height: 150px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        /* Right panel - Navigation */
        .right-panel {
            width: 280px;
            background-color: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex: 1;
        }
        
        /* Candidate info */
        .candidate-info {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        
        .candidate-avatar {
            width: 40px;
            height: 40px;
            background-color: #ddd;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
        }
        
        .candidate-name {
            font-weight: bold;
        }
        
        /* Legend */
        .legend {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .legend-color.answered {
            background-color: #22c55e;
            clip-path: polygon(50% 0%, 100% 30%, 80% 100%, 20% 100%, 0% 30%);
        }
        
        .legend-color.not-answered {
            background-color: #ef4444;
            clip-path: polygon(20% 0%, 80% 0%, 100% 70%, 50% 100%, 0% 70%);
        }
        
        .legend-color.not-visited {
            background-color: #d1d5db;
        }
        
        .legend-color.marked {
            background-color: #a855f7;
            border-radius: 50%;
        }
        
        .legend-color.answered-marked {
            background-color: #6b21a8;
            position: relative;
            border-radius: 50%;
        }
        
        .legend-color.answered-marked::after {
            content: "✓";
            position: absolute;
            bottom: -2px;
            right: -2px;
            background-color: white;
            color: green;
            width: 12px;
            height: 12px;
            font-size: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 1px;
        }
        
        /* Section blue strip */
        .section-strip {
            background-color: #0066cc;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }
        
        /* Question palette */
        .question-palette {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }
        
        .question-btn {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            position: relative;
            font-family: Arial, sans-serif;
            line-height: 35px;
            text-align: center;
        }
        
        .question-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .question-btn.active {
            border: 2px solid #2196f3;
            box-shadow: 0 2px 5px rgba(33,150,243,0.3);
        }
        
        .question-btn.answered {
            background-color: #22c55e; /* Green */
            color: white;
            clip-path: polygon(50% 0%, 100% 30%, 80% 100%, 20% 100%, 0% 30%);
        }
        
        .question-btn.not-answered {
            background-color: #ef4444; /* Red */
            color: white;
            clip-path: polygon(20% 0%, 80% 0%, 100% 70%, 50% 100%, 0% 70%);
        }
        
        .question-btn.not-visited {
            background-color: #d1d5db; /* Light Gray */
            color: #000;
        }
        
        .question-btn.marked {
            background-color: #a855f7; /* Purple */
            color: white;
            border-radius: 50%;
        }
        
        .question-btn.answered-marked {
            background-color: #6b21a8; /* Deep Purple */
            color: white;
            position: relative;
            border-radius: 50%;
        }
        
        .question-btn.answered-marked::after {
            content: "✓";
            position: absolute;
            bottom: -2px;
            right: -2px;
            background-color: white;
            color: green;
            width: 12px;
            height: 12px;
            font-size: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 1px;
        }
        
        /* Left footer */
        .left-footer {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 10px;
            display: flex;
            gap: 10px;
            padding-left: 10px;
        }
        
        /* Right footer */
        .right-footer {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 10px;
            display: flex;
            justify-content: center;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            background-color: #f5f5f5;
        }
        
        .mark-btn {
            color: #9c27b0;
        }
        
        .clear-btn {
            color: #ff9800;
        }
        
        .prev-btn {
            color: #607d8b;
        }
        
        .save-btn {
            color: #2196f3;
            background-color: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .submit-btn {
            background-color: #d32f2f;
            color: white;
            border: none;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body onload="goFullScreen()">
    <div class="exam-container">
        <!-- Top blue strip with paper name -->
        <div class="top-strip" id="examTitle">
            Loading exam...
        </div>
        
        <!-- Black strip with paper indicator and buttons -->
        <div class="black-strip">
            <div class="paper-indicator" id="examType">Loading...</div>
            <div class="strip-buttons">
                <div class="strip-btn" id="viewInstructions">
                    <i class="fas fa-info-circle"></i> View Instructions
                </div>
                <div class="strip-btn">
                    <i class="fas fa-clock"></i> <span id="timer">03:00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="main-content">
            <!-- Left container - Question display and its footer -->
            <div class="left-container">
                <!-- Left panel - Question display -->
                <div class="left-panel">
                    <!-- Section tabs strip -->
                    <div class="sections-strip" id="sectionsStrip">
                        <div class="section-tab active">All Questions</div>
                    </div>
                    
                    <!-- Blue language strip -->
                    <div class="language-strip">
                        <div class="language-selector">
                            View in: 
                            <select id="languageSelector">
                                <option>English</option>
                                <option>Hindi</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Question area -->
                    <div class="question-area">
                        <div class="question-number" id="questionNumber">Question No. 1</div>
                        
                        <div class="question-content">
                            <div class="question-text" id="questionText">
                                <p>Loading question...</p>
                            </div>
                            
                            <div class="question-image" id="questionImage">
                                <!-- Question image will be loaded here -->
                            </div>
                            
                            <div class="options" id="optionsList">
                                <!-- Options will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Left footer with action buttons -->
                <div class="left-footer">
                    <button class="action-btn mark-btn" id="markQuestion">Mark for Review & Next</button>
                    <button class="action-btn clear-btn" id="clearResponse">Clear Response</button>
                    <button class="action-btn prev-btn" id="prevQuestion">Previous</button>
                    <button class="action-btn save-btn" id="nextQuestion">Save & Next</button>
                </div>
            </div>
            
            <!-- Right container - Navigation and its footer -->
            <div class="right-container">
                <!-- Right panel - Navigation -->
                <div class="right-panel">
                    <!-- Candidate info -->
                    <div class="candidate-info">
                        <div class="candidate-avatar" id="userInitials"></div>
                        <div class="candidate-name" id="userName">Candidate</div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color answered"></div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-answered"></div>
                            <span>Not Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-visited"></div>
                            <span>Not Visited</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color marked"></div>
                            <span>Marked for Review</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color answered-marked"></div>
                            <span>Answered & Marked for Review</span>
                        </div>
                    </div>
                    
                    <!-- Section blue strip -->
                    <div class="section-strip" id="currentSection">
                        All Questions
                    </div>
                    
                    <!-- Question palette -->
                    <div class="question-palette" id="questionPalette">
                        <!-- Question buttons will be generated dynamically -->
                    </div>
                </div>
                
                <!-- Right footer with submit button -->
                <div class="right-footer">
                    <button class="action-btn submit-btn" id="submitExam">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Confirmation Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Submit Exam</h3>
                <button class="modal-close" id="closeSubmitModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your exam?</p>
                <p id="summaryText">You have answered 0 out of 0 questions.</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancelSubmit">Cancel</button>
                <button class="action-btn submit-btn" id="confirmSubmit">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Function to go full screen
        function goFullScreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) { // Firefox
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { // Chrome, Safari and Opera
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { // IE/Edge
                elem.msRequestFullscreen();
            }
            
            // Also try F11 key simulation
            try {
                const event = new KeyboardEvent('keydown', {
                    key: 'F11',
                    keyCode: 122,
                    which: 122,
                    code: 'F11',
                    bubbles: true
                });
                document.dispatchEvent(event);
            } catch (e) {
                console.log('F11 simulation failed:', e);
            }
        }
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtkee-Lv8lEMestaSVJxx7yvKB-lBygPQ",
            authDomain: "prepsharp-c91fd.firebaseapp.com",
            projectId: "prepsharp-c91fd",
            storageBucket: "prepsharp-c91fd.firebasestorage.app",
            messagingSenderId: "688294848433",
            appId: "1:688294848433:web:dd93fc6d61d62392473f90",
            measurementId: "G-LLJSLMXMNY"
        };
        
        // Initialize Firebase
        let db;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        // Get exam ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        
        // Exam state
        let examData = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let markedQuestions = {};
        let examDuration = 3 * 60 * 60; // 3 hours in seconds
        let timeRemaining = examDuration;
        let timerInterval;
        
        // DOM elements
        const examTitle = document.getElementById('examTitle');
        const examType = document.getElementById('examType');
        const timerElement = document.getElementById('timer');
        const questionNumber = document.getElementById('questionNumber');
        const questionText = document.getElementById('questionText');
        const questionImage = document.getElementById('questionImage');
        const optionsList = document.getElementById('optionsList');
        const questionPalette = document.getElementById('questionPalette');
        const prevButton = document.getElementById('prevQuestion');
        const nextButton = document.getElementById('nextQuestion');
        const markButton = document.getElementById('markQuestion');
        const clearButton = document.getElementById('clearResponse');
        const submitButton = document.getElementById('submitExam');
        const userName = document.getElementById('userName');
        const userInitials = document.getElementById('userInitials');
        
        // Modal elements
        const submitModal = document.getElementById('submitModal');
        const closeSubmitModal = document.getElementById('closeSubmitModal');
        const cancelSubmit = document.getElementById('cancelSubmit');
        const confirmSubmit = document.getElementById('confirmSubmit');
        
        // Load user info
        function loadUserInfo() {
            const loggedInUser = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                const name = userData.name || userData.email || 'User';
                userName.textContent = name;
                
                // Set initials
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                userInitials.textContent = initials;
            }
        }
        
        // Load exam data
        async function loadExam() {
            // Check if we're in demo mode
            const isDemo = urlParams.get('demo') === 'true';
            
            if (!examId && !isDemo) {
                alert('No exam ID provided');
                window.location.href = '../dashboards/free/practice-papers.html';
                return;
            }
            
            if (isDemo) {
                // Create demo exam data
                examData = {
                    id: 'demo',
                    name: 'Demo Exam',
                    type: 'jee-main',
                    year: '2023',
                    description: 'This is a demo exam to showcase the exam interface.',
                    subjects: ['physics', 'chemistry', 'mathematics']
                };
                
                // Update exam info
                examTitle.textContent = examData.name;
                examType.textContent = getExamTypeDisplay(examData.type);
                
                // Create dummy questions
                questions = createDummyQuestions(90);
                
                // Update section tabs
                updateSectionTabs();
                
                // Generate question palette
                generateQuestionPalette();
                
                // Show first question
                showQuestion(0);
                
                // Start timer
                startTimer();
                
                return;
            }
            
            try {
                const examDoc = await db.collection('papers').doc(examId).get();
                
                if (!examDoc.exists) {
                    alert('Exam not found');
                    window.location.href = '../dashboards/free/practice-papers.html';
                    return;
                }
                
                examData = examDoc.data();
                examData.id = examId;
                
                // Update exam info
                examTitle.textContent = examData.name || 'Unnamed Exam';
                examType.textContent = getExamTypeDisplay(examData.type || 'unknown');
                
                // Load questions
                await loadQuestions();
                
                // Start timer
                startTimer();
                
            } catch (error) {
                console.error('Error loading exam:', error);
                alert('Failed to load exam. Please try again.');
            }
        }
        
        // Load questions
        async function loadQuestions() {
            try {
                // Check if questions are embedded in the exam document
                if (examData.questions && Array.isArray(examData.questions)) {
                    questions = examData.questions;
                } else {
                    // Try to load questions from subcollection
                    const questionsSnapshot = await db.collection('papers').doc(examId).collection('questions').get();
                    questions = [];
                    questionsSnapshot.forEach(doc => {
                        const question = doc.data();
                        question.id = doc.id;
                        questions.push(question);
                    });
                }
                
                // If no questions found, create some dummy questions for testing
                if (questions.length === 0) {
                    console.log('No questions found, creating dummy questions');
                    questions = createDummyQuestions(90);
                }
                
                // Update section tabs if needed
                updateSectionTabs();
                
                // Generate question palette
                generateQuestionPalette();
                
                // Show first question
                showQuestion(0);
                
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Please try again.');
            }
        }
        
        // Create dummy questions for testing
        function createDummyQuestions(count) {
            const dummyQuestions = [];
            const imageUrls = [
                'https://prepsharp.com/images/questions/physics1.png',
                'https://prepsharp.com/images/questions/chemistry1.png',
                'https://prepsharp.com/images/questions/math1.png',
                'https://prepsharp.com/images/questions/physics2.png',
                'https://prepsharp.com/images/questions/chemistry2.png'
            ];
            
            for (let i = 0; i < count; i++) {
                // Add image to some questions
                const hasImage = Math.random() > 0.5;
                const imageUrl = hasImage ? imageUrls[i % imageUrls.length] : null;
                
                // Create options with images for some options
                const options = [];
                for (let j = 0; j < 4; j++) {
                    const hasOptionImage = Math.random() > 0.7;
                    if (hasOptionImage) {
                        options.push(`<div>Option ${String.fromCharCode(65 + j)} for question ${i+1}</div><div class="option-image"><img src="${imageUrls[(i+j) % imageUrls.length]}" alt="Option ${String.fromCharCode(65 + j)}"></div>`);
                    } else {
                        options.push(`Option ${String.fromCharCode(65 + j)} for question ${i+1}`);
                    }
                }
                
                dummyQuestions.push({
                    id: `q${i}`,
                    text: `This is question ${i+1}. What is the correct answer?`,
                    imageUrl: imageUrl,
                    options: options,
                    answer: ['a', 'b', 'c', 'd'][Math.floor(Math.random() * 4)]
                });
            }
            return dummyQuestions;
        }
        
        // Update section tabs based on exam type
        function updateSectionTabs() {
            const sectionsStrip = document.getElementById('sectionsStrip');
            const currentSection = document.getElementById('currentSection');
            
            // Clear existing tabs
            sectionsStrip.innerHTML = '';
            
            if (examData.type === 'jee-advanced') {
                // JEE Advanced has 6 sections
                const sections = [
                    'Physics Section 1',
                    'Physics Section 2',
                    'Chemistry Section 1',
                    'Chemistry Section 2',
                    'Mathematics Section 1',
                    'Mathematics Section 2'
                ];
                
                sections.forEach((section, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'section-tab' + (index === 0 ? ' active' : '');
                    tab.textContent = section;
                    tab.dataset.section = index;
                    
                    tab.addEventListener('click', () => {
                        // Update active tab
                        document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Update current section display
                        currentSection.textContent = section;
                        
                        // Show first question of this section
                        const sectionStart = index * 15; // Assuming 15 questions per section
                        showQuestion(sectionStart);
                    });
                    
                    sectionsStrip.appendChild(tab);
                });
                
                // Set initial section
                currentSection.textContent = 'Physics Section 1';
                
            } else {
                // JEE Main and others have 3 sections
                const sections = ['Physics', 'Chemistry', 'Mathematics'];
                
                sections.forEach((section, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'section-tab' + (index === 0 ? ' active' : '');
                    tab.textContent = section;
                    tab.dataset.section = index;
                    
                    tab.addEventListener('click', () => {
                        // Update active tab
                        document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Update current section display
                        currentSection.textContent = section;
                        
                        // Show first question of this section
                        const sectionStart = index * 30; // Assuming 30 questions per section
                        showQuestion(sectionStart);
                    });
                    
                    sectionsStrip.appendChild(tab);
                });
                
                // Set initial section
                currentSection.textContent = 'Physics';
            }
        }
        
        // Generate question palette
        function generateQuestionPalette() {
            questionPalette.innerHTML = '';
            
            for (let i = 0; i < questions.length; i++) {
                const questionBtn = document.createElement('div');
                questionBtn.className = 'question-btn not-visited';
                questionBtn.textContent = i + 1;
                questionBtn.dataset.index = i;
                
                if (i === currentQuestionIndex) {
                    questionBtn.classList.remove('not-visited');
                    questionBtn.classList.add('not-answered', 'active');
                }
                
                questionBtn.addEventListener('click', () => {
                    showQuestion(i);
                });
                
                questionPalette.appendChild(questionBtn);
            }
        }
        
        // Show question
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            // Update current question index
            currentQuestionIndex = index;
            
            // Update question number
            questionNumber.textContent = `Question No. ${index + 1}`;
            
            // Update question palette
            updateQuestionPalette();
            
            // Get current question
            const question = questions[index];
            
            // Update question text
            questionText.innerHTML = question.text || `Question ${index + 1}`;
            
            // Update question image
            if (question.imageUrl) {
                questionImage.innerHTML = `<img src="${question.imageUrl}" alt="Question ${index + 1}">`;
                questionImage.style.display = 'block';
            } else {
                questionImage.innerHTML = '';
                questionImage.style.display = 'none';
            }
            
            // Update options
            optionsList.innerHTML = '';
            
            const options = question.options || ['Option A', 'Option B', 'Option C', 'Option D'];
            const optionLabels = ['a', 'b', 'c', 'd'];
            
            options.forEach((option, i) => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option';
                
                const isSelected = userAnswers[index] === optionLabels[i];
                
                optionItem.innerHTML = `
                    <input type="radio" name="q${index}" id="q${index}-${optionLabels[i]}" class="option-radio" ${isSelected ? 'checked' : ''}>
                    <label for="q${index}-${optionLabels[i]}" class="option-label">
                        <div class="option-letter">${optionLabels[i]})</div>
                        <div class="option-text">${option}</div>
                    </label>
                `;
                
                const radioInput = optionItem.querySelector('input');
                radioInput.addEventListener('change', () => {
                    if (radioInput.checked) {
                        selectOption(index, optionLabels[i]);
                    }
                });
                
                // Make the whole option clickable
                optionItem.addEventListener('click', () => {
                    radioInput.checked = true;
                    selectOption(index, optionLabels[i]);
                });
                
                optionsList.appendChild(optionItem);
            });
            
            // Update mark button text
            markButton.textContent = markedQuestions[index] ? 'Unmark & Next' : 'Mark for Review & Next';
            
            // Update section tabs if needed
            updateActiveSectionTab(index);
        }
        
        // Update active section tab based on question index
        function updateActiveSectionTab(index) {
            const tabs = document.querySelectorAll('.section-tab');
            if (tabs.length <= 1) return;
            
            let sectionIndex;
            if (examData.type === 'jee-advanced') {
                // 6 sections with 15 questions each
                sectionIndex = Math.floor(index / 15);
            } else {
                // 3 sections with 30 questions each
                sectionIndex = Math.floor(index / 30);
            }
            
            // Update active tab
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === sectionIndex);
            });
            
            // Update current section display
            const currentSection = document.getElementById('currentSection');
            currentSection.textContent = tabs[sectionIndex].textContent;
        }
        
        // Update question palette
        function updateQuestionPalette() {
            const questionBtns = questionPalette.querySelectorAll('.question-btn');
            
            questionBtns.forEach((btn, i) => {
                // Remove all status classes
                btn.classList.remove('not-visited', 'not-answered', 'answered', 'marked', 'answered-marked', 'active');
                
                // Add appropriate class based on status
                if (i === currentQuestionIndex) {
                    btn.classList.add('active');
                    
                    if (userAnswers[i] !== undefined) {
                        if (markedQuestions[i]) {
                            btn.classList.add('answered-marked');
                        } else {
                            btn.classList.add('answered');
                        }
                    } else {
                        if (markedQuestions[i]) {
                            btn.classList.add('marked');
                        } else {
                            btn.classList.add('not-answered');
                        }
                    }
                } else {
                    if (userAnswers[i] !== undefined) {
                        if (markedQuestions[i]) {
                            btn.classList.add('answered-marked');
                        } else {
                            btn.classList.add('answered');
                        }
                    } else if (markedQuestions[i]) {
                        btn.classList.add('marked');
                    } else if (i < currentQuestionIndex) {
                        btn.classList.add('not-answered');
                    } else {
                        btn.classList.add('not-visited');
                    }
                }
            });
        }
        
        // Select option
        function selectOption(questionIndex, option) {
            userAnswers[questionIndex] = option;
            updateQuestionPalette();
        }
        
        // Clear response
        function clearResponse() {
            delete userAnswers[currentQuestionIndex];
            showQuestion(currentQuestionIndex);
        }
        
        // Mark/unmark question
        function toggleMarkQuestion() {
            markedQuestions[currentQuestionIndex] = !markedQuestions[currentQuestionIndex];
            updateQuestionPalette();
            
            // Go to next question if available
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        }
        
        // Start timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                    return;
                }
                
                updateTimerDisplay();
                
                // Warning when 15 minutes remaining
                if (timeRemaining === 15 * 60) {
                    alert('15 minutes remaining!');
                }
            }, 1000);
            
            updateTimerDisplay();
        }
        
        // Update timer display
        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Show submit confirmation
        function showSubmitConfirmation() {
            const answeredCount = Object.keys(userAnswers).length;
            const totalQuestions = questions.length;
            
            document.getElementById('summaryText').textContent = `You have answered ${answeredCount} out of ${totalQuestions} questions.`;
            submitModal.classList.add('active');
        }
        
        // Submit exam
        function submitExam() {
            clearInterval(timerInterval);
            
            // Calculate score
            let score = 0;
            let totalQuestions = questions.length;
            
            for (let i = 0; i < totalQuestions; i++) {
                if (userAnswers[i] === questions[i].answer) {
                    score++;
                }
            }
            
            // Save result to Firestore
            const userId = getUserId();
            const result = {
                examId: examId,
                examName: examData.name,
                score: score,
                totalQuestions: totalQuestions,
                percentage: (score / totalQuestions) * 100,
                timeSpent: examDuration - timeRemaining,
                answers: userAnswers,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(userId).collection('results').add(result)
                .then(() => {
                    // Redirect to results page
                    window.location.href = `result.html?examId=${examId}&score=${score}&total=${totalQuestions}`;
                })
                .catch(error => {
                    console.error('Error saving result:', error);
                    alert('Failed to save your result. Please try again.');
                });
        }
        
        // Get user ID
        function getUserId() {
            const loggedInUser = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                return userData.email || 'default-user';
            }
            return 'default-user';
        }
        
        // Get exam type display name
        function getExamTypeDisplay(type) {
            switch(type) {
                case 'jee-main':
                    return 'JEE Main';
                case 'jee-advanced':
                    return 'JEE Advanced';
                case 'neet':
                    return 'NEET';
                case 'bitsat':
                    return 'BITSAT';
                case 'aiims':
                    return 'AIIMS';
                default:
                    return type.toUpperCase();
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load user info
            loadUserInfo();
            
            // Load exam
            loadExam();
            
            // Navigation buttons
            prevButton.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    showQuestion(currentQuestionIndex - 1);
                }
            });
            
            nextButton.addEventListener('click', () => {
                // Save current answer and go to next question
                if (currentQuestionIndex < questions.length - 1) {
                    showQuestion(currentQuestionIndex + 1);
                }
            });
            
            // Mark button
            markButton.addEventListener('click', toggleMarkQuestion);
            
            // Clear button
            clearButton.addEventListener('click', clearResponse);
            
            // Submit button
            submitButton.addEventListener('click', showSubmitConfirmation);
            
            // View instructions button
            document.getElementById('viewInstructions').addEventListener('click', () => {
                alert('Exam Instructions:\n\n1. The exam consists of multiple-choice questions.\n2. Each question has only one correct answer.\n3. There is no negative marking.\n4. You can mark questions for review and return to them later.\n5. Click "Submit" when you are done with the exam.');
            });
            
            // Modal close buttons
            closeSubmitModal.addEventListener('click', () => {
                submitModal.classList.remove('active');
            });
            
            cancelSubmit.addEventListener('click', () => {
                submitModal.classList.remove('active');
            });
            
            confirmSubmit.addEventListener('click', submitExam);
            
            // Close modal when clicking outside
            submitModal.addEventListener('click', (e) => {
                if (e.target === submitModal) {
                    submitModal.classList.remove('active');
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Prevent keyboard shortcuts during input focus
                if (document.activeElement.tagName === 'INPUT') return;
                
                if (e.key === 'ArrowLeft' || e.key === 'p' || e.key === 'P') {
                    // Previous question
                    if (currentQuestionIndex > 0) {
                        showQuestion(currentQuestionIndex - 1);
                    }
                } else if (e.key === 'ArrowRight' || e.key === 'n' || e.key === 'N') {
                    // Next question
                    if (currentQuestionIndex < questions.length - 1) {
                        showQuestion(currentQuestionIndex + 1);
                    }
                } else if (e.key === 'm' || e.key === 'M') {
                    // Mark for review
                    toggleMarkQuestion();
                } else if (e.key === 'c' || e.key === 'C') {
                    // Clear response
                    clearResponse();
                } else if (e.key >= '1' && e.key <= '4') {
                    // Select option (1-4 for A-D)
                    const optionIndex = parseInt(e.key) - 1;
                    const optionLabels = ['a', 'b', 'c', 'd'];
                    if (optionIndex >= 0 && optionIndex < 4) {
                        selectOption(currentQuestionIndex, optionLabels[optionIndex]);
                        const radioInput = document.getElementById(`q${currentQuestionIndex}-${optionLabels[optionIndex]}`);
                        if (radioInput) radioInput.checked = true;
                    }
                }
            });
        });
    </script>
</body>
</html>