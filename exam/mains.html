<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>JEE Main 2024 27 Jan Shift 1 - PrepSharp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="exam-style.css">
    <link rel="stylesheet" href="mobile-styles.css">

</head>
<body onload="initMobile()">
    <div class="exam-container">
        <!-- Top strip with NTA logo and user info -->
        <div class="top-strip">
            <img src="../images/nta logo.png" alt="NTA Logo" class="nta-logo">
            <div class="top-right-user">
                <div class="candidate-avatar square" id="userInitials">JS</div>
                <div class="candidate-info-container">
                    <div><span class="candidate-label">Candidate Name:</span> <span id="userName">John Smith</span></div>
                    <div><span class="candidate-label">Candidate ID:</span> <span id="userId">JEE2024001234</span></div>
                    <div><span class="candidate-label">Time Remaining:</span> <span class="time-remaining" id="timeRemaining">02:59:45</span></div>
                </div>
            </div>
        </div>
        
        <!-- Purple strip with system and lab info -->
        <div class="purple-strip">
            <div>System No.: <span id="systemNo">C32</span></div>
            <div>Lab No.: <span id="labNo">LAB-A</span></div>
        </div>
        
        <!-- Black strip with paper indicator and buttons -->
        <div class="black-strip">
            <div class="paper-indicator"><span id="examType">Loading...</span> <span id="paperYear"></span> <span id="paperName">Loading...</span></div>
            <div class="strip-buttons">
                <div class="strip-btn" id="viewPaper">
                    <i class="fas fa-file-alt"></i> Question Paper
                </div>
                <div class="strip-btn" id="viewInstructions">
                    <i class="fas fa-info-circle"></i> View Instructions
                </div>
                <div class="strip-btn">
                    <i class="fas fa-clock"></i> <span id="timer">03:00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="main-content">
            <!-- Left container - Question display and its footer -->
            <div class="left-container">
                <!-- Left panel - Question display -->
                <div class="left-panel">
                    <!-- Section tabs strip -->
                    <div class="sections-strip" id="sectionsStrip">
                        <div class="section-tab active">Physics Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Physics Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Chemistry Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Chemistry Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Mathematics Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Mathematics Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                    </div>
                    
                    <!-- Blue language strip -->
                    <div class="language-strip">
                        <div class="language-selector">
                            View in: 
                            <select id="languageSelector">
                                <option>English</option>
                                <option>Hindi</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Question area -->
                    <div class="question-area">
                        <!-- Watermark with grid layout -->
                        <div class="watermark">
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                        </div>
                        
                        <div class="question-number" id="questionNumber">Question No. 3</div>
                        
                        <div class="question-content">
                            <div class="question-text" id="questionText">
                                <p>A particle of mass m is moving in a circular orbit of radius r under the influence of an attractive central force F = -kr where k is a positive constant. If the angular momentum of the particle is L, then the total energy of the particle is:</p>
                            </div>
                            
                            <div class="question-image" id="questionImage">
                                <img src="https://prepsharp.com/images/questions/physics1.png" alt="Question 1">
                            </div>
                            
                            <div class="options" id="optionsList">
                                <!-- For MCQ questions -->
                                <div class="mcq-options" id="mcqOptions" style="display: none;">
                                    <div class="option" style="display: block;">
                                        <input type="radio" name="q3" id="q3-a" class="option-radio">
                                        <label for="q3-a" class="option-label">
                                            <div class="option-letter">a)</div>
                                            <div class="option-text">L²/2mr² - kr²/2</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option" style="display: block;">
                                        <input type="radio" name="q3" id="q3-b" class="option-radio">
                                        <label for="q3-b" class="option-label">
                                            <div class="option-letter">b)</div>
                                            <div class="option-text">L²/2mr² + kr²/2</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option" style="display: block;">
                                        <input type="radio" name="q3" id="q3-c" class="option-radio">
                                        <label for="q3-c" class="option-label">
                                            <div class="option-letter">c)</div>
                                            <div class="option-text">L²/2mr² - kr²</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option" style="display: block;">
                                        <input type="radio" name="q3" id="q3-d" class="option-radio" checked>
                                        <label for="q3-d" class="option-label">
                                            <div class="option-letter">d)</div>
                                            <div class="option-text">L²/mr² - kr²/2</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Numerical Answer Section (for Section 2) -->
                            <div id="numericalSection" style="display: block; margin-top: 20px; background: #fffde7; border-radius: 12px; padding: 20px; border: 2px solid #f9a825; box-shadow: 0 4px 8px rgba(249, 168, 37, 0.15);">
                                <h3 style="margin-top: 0; color: #f9a825; font-size: 18px; text-align: center;">Numerical Answer</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="numerical-answer" style="display: block; margin-bottom: 8px; font-weight: 600; color: #f57f17;">Your Answer:</label>
                                    <input type="number" id="numerical-answer" style="width: 100%; padding: 12px; font-size: 18px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; background: white; box-shadow: 0 2px 6px rgba(249, 168, 37, 0.1);">
                                </div>
                                
                                <!-- On-screen keyboard -->
                                <div class="virtual-keyboard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; max-width: 300px; margin: 0 auto 15px; touch-action: manipulation;">
                                    <button class="num-key" data-value="1" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">1</button>
                                    <button class="num-key" data-value="2" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">2</button>
                                    <button class="num-key" data-value="3" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">3</button>
                                    <button class="num-key" data-value="+" style="padding: 12px 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">+</button>
                                    <button class="num-key" data-value="4" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">4</button>
                                    <button class="num-key" data-value="5" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">5</button>
                                    <button class="num-key" data-value="6" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">6</button>
                                    <button class="num-key" data-value="-" style="padding: 12px 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">-</button>
                                    <button class="num-key" data-value="7" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">7</button>
                                    <button class="num-key" data-value="8" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">8</button>
                                    <button class="num-key" data-value="9" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">9</button>
                                    <button class="num-key" data-value="." style="padding: 12px 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; touch-action: manipulation;">.</button>
                                    <button class="num-key" data-value="0" style="padding: 12px 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 2; touch-action: manipulation;">0</button>
                                    <button id="backspace" style="padding: 12px 8px; font-size: 16px; background: #fff59d; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 2; touch-action: manipulation;"><i class="fas fa-backspace"></i></button>
                                    <button id="clear-all" style="padding: 12px 8px; font-size: 16px; background: #ffee58; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 4; margin-top: 6px; touch-action: manipulation;">Clear</button>
                                </div>
                                
                                <div style="background: #fff8e1; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 3px solid #ffca28;">
                                    <p style="margin: 0; font-size: 14px; color: #f57f17;"><strong>Instructions:</strong></p>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 14px; color: #795548;">
                                        <li>Enter your numerical answer using the keypad above</li>
                                        <li>Use decimal point (.) for decimal values if needed</li>
                                        <li>Use minus (-) for negative values if needed</li>
                                        <li>Use plus (+) for positive values if needed</li>
                                        <li>Do not include units in your answer</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Left footer with action buttons -->
                <div class="left-footer">
                    <button class="action-btn mark-btn" id="markQuestion">Mark for Review & Next</button>
                    <button class="action-btn clear-btn" id="clearResponse">Clear Response</button>
                    <button class="action-btn prev-btn" id="prevQuestion">Previous</button>
                    <button class="action-btn save-btn" id="nextQuestion">Save & Next</button>
                </div>
            </div>
            
            <!-- Right container - Navigation and its footer -->
            <div class="right-container">
                <!-- Right panel - Navigation -->
                <div class="right-panel">
                    <!-- Candidate info moved to top strip -->
                    
                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color answered"></div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-answered"></div>
                            <span>Not Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-visited"></div>
                            <span>Not Visited</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color marked"></div>
                            <span>Marked for Review</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color answered-marked"></div>
                            <span>Answered & Marked for Review</span>
                        </div>
                    </div>
                    
                    <!-- Section blue strip -->
                    <div class="section-strip" id="currentSection">
                        Physics Section 1
                    </div>
                    
                    <!-- Question palette -->
                    <div class="question-palette" id="questionPalette">
                        <!-- Chemistry Section 1: 20 questions (25-44) -->
                        <div class="question-btn answered">1</div>
                        <div class="question-btn answered">2</div>
                        <div class="question-btn not-answered active">3</div>
                        <div class="question-btn not-visited">4</div>
                        <div class="question-btn not-visited">5</div>
                        <div class="question-btn not-visited">6</div>
                        <div class="question-btn not-visited">7</div>
                        <div class="question-btn not-visited">8</div>
                        <div class="question-btn not-visited">9</div>
                        <div class="question-btn not-visited">10</div>
                        <div class="question-btn not-visited">11</div>
                        <div class="question-btn not-visited">12</div>
                        <div class="question-btn not-visited">13</div>
                        <div class="question-btn not-visited">14</div>
                        <div class="question-btn not-visited">15</div>
                        <div class="question-btn marked">16</div>
                        <div class="question-btn answered-marked">17</div>
                        <div class="question-btn not-visited">18</div>
                        <div class="question-btn not-visited">19</div>
                        <div class="question-btn not-visited">20</div>
                    </div>
                </div>
                
                <!-- Right footer with submit button -->
                <div class="right-footer">
                    <button class="action-btn submit-btn" id="submitExam">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Confirmation Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Submit Exam</h3>
                <button class="modal-close" id="closeSubmitModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your exam?</p>
                <p id="summaryText">You have answered <span id="answeredCount">0</span> out of <span id="totalCount">75</span> questions.</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancelSubmit">Cancel</button>
                <button class="action-btn submit-btn" id="confirmSubmit">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile initialization -->
    <script>
        function initMobile() {
            // Check if mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Force landscape on page load (iOS and Android)
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                } else if (screen.lockOrientation) {
                    screen.lockOrientation('landscape');
                } else if (screen.mozLockOrientation) {
                    screen.mozLockOrientation('landscape');
                } else if (screen.msLockOrientation) {
                    screen.msLockOrientation('landscape');
                }
                
                // Prevent zoom on input focus
                document.addEventListener('touchstart', function() {}, {passive: true});
                
                // Handle orientation changes
                window.addEventListener('orientationchange', function() {
                    setTimeout(function() {
                        window.scrollTo(0, 0);
                    }, 100);
                });
                
                // Prevent pull-to-refresh
                document.body.style.overscrollBehavior = 'none';
            } else {
                // Desktop - try fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(() => {});
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="timer.js"></script>
    <script src="exam-script.js"></script>
    <script src="timer-integration.js"></script>
    <script src="section-info.js"></script>
    
    <script>
        // Exam tracking variables
        let examData = {
            studentId: '',
            studentName: '',
            email: '',
            examId: 'JEE_MAIN_2025_JAN_SHIFT1',
            examName: 'JEE Main Jan 2025 - Shift 1',
            examDate: new Date().toISOString().split('T')[0],
            startTime: new Date().toISOString(),
            endTime: null,
            totalDuration: 180,
            responses: {},
            questionTimes: {},
            subjectTimes: { physics: 0, chemistry: 0, mathematics: 0 },
            currentQuestion: 1,
            totalQuestions: 75
        };
        
        // Sample questions data (in real app, load from database)
        const questionsData = {
            1: { subject: 'physics', chapter: 'kinematics', correctAnswer: 'B', difficulty: 'easy', type: 'mcq', marks: 4, needsOnScreenKeyboard: 'no' },
            2: { subject: 'physics', chapter: 'mechanics', correctAnswer: 'A', difficulty: 'moderate', type: 'mcq', marks: 4, needsOnScreenKeyboard: 'no' },
            3: { subject: 'physics', chapter: 'thermodynamics', correctAnswer: 'C', difficulty: 'hard', type: 'mcq', marks: 4, needsOnScreenKeyboard: 'no' },
            22: { subject: 'physics', chapter: 'numerical', correctAnswer: '15', difficulty: 'hard', type: 'numerical', marks: 4, needsOnScreenKeyboard: 'yes' },
            // Add more questions as needed
        };
        
        // Initialize exam data
        function initializeExam() {
            const loggedInUser = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                examData.email = userData.email;
                examData.studentName = userData.name || userData.email;
                examData.studentId = 'JEE2024' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                // Get exam ID from localStorage
                const examId = localStorage.getItem('examId');
                const examName = localStorage.getItem('examName');
                if (examId) {
                    examData.examId = examId;
                    examData.examName = examName || examId.replace(/_/g, ' ');
                }
                
                // Update UI
                document.getElementById('userName').textContent = examData.studentName;
                document.getElementById('userId').textContent = examData.studentId;
                
                // Update watermarks
                document.querySelectorAll('.watermark-text').forEach(el => {
                    el.textContent = examData.studentId;
                });
            }
        }
        
        // Track question response
        function saveResponse(questionId, answer, timeSpent, isNumerical = false) {
            const response = {
                questionId: questionId,
                userAnswer: answer,
                timeSpent: timeSpent,
                timestamp: new Date().toISOString(),
                isAttempted: answer !== null,
                isMarkedForReview: false,
                isNumerical: isNumerical
            };
            
            examData.responses[questionId] = response;
            return response;
        }
        
        // Update question display based on Firebase data
        function updateQuestionDisplay() {
            const questionId = examData.currentQuestion;
            
            if (needsOnScreenKeyboard()) {
                setQuestionType('numerical');
                
                // Clear any selected MCQ options if switching to numerical
                document.querySelectorAll('.option-radio').forEach(radio => {
                    radio.checked = false;
                });
                
                // Load saved numerical answer if it exists
                const savedResponse = examData.responses[questionId];
                if (savedResponse && savedResponse.isNumerical) {
                    document.getElementById('numerical-answer').value = savedResponse.userAnswer || '';
                } else {
                    document.getElementById('numerical-answer').value = '';
                }
            } else {
                setQuestionType('mcq');
                
                // Clear numerical input
                document.getElementById('numerical-answer').value = '';
                
                // Load saved MCQ answer if it exists
                const savedResponse = examData.responses[questionId];
                if (savedResponse && !savedResponse.isNumerical && savedResponse.userAnswer) {
                    const radioId = `q${questionId}-${savedResponse.userAnswer.toLowerCase()}`;
                    const radioElement = document.getElementById(radioId);
                    if (radioElement) radioElement.checked = true;
                }
            }
        }
        
        // Calculate results
        function calculateResults() {
            let correct = 0, incorrect = 0, attempted = 0, unattempted = 0;
            let totalMarks = 0;
            let subjectStats = {
                physics: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 },
                chemistry: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 },
                mathematics: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 }
            };
            
            for (let i = 1; i <= examData.totalQuestions; i++) {
                const response = examData.responses[i];
                const question = questionsData[i];
                
                if (!question) continue;
                
                if (response && response.isAttempted) {
                    attempted++;
                    subjectStats[question.subject].attempted++;
                    
                    if (response.userAnswer === question.correctAnswer) {
                        correct++;
                        subjectStats[question.subject].correct++;
                        totalMarks += question.marks;
                        subjectStats[question.subject].marks += question.marks;
                    } else {
                        incorrect++;
                        subjectStats[question.subject].incorrect++;
                        // Negative marking: -1 for wrong answer
                        totalMarks -= 1;
                        subjectStats[question.subject].marks -= 1;
                    }
                } else {
                    unattempted++;
                    subjectStats[question.subject].unattempted++;
                }
            }
            
            return {
                totalQuestions: examData.totalQuestions,
                attempted,
                correct,
                incorrect,
                unattempted,
                totalMarks: Math.max(0, totalMarks),
                maxMarks: examData.totalQuestions * 4,
                accuracy: attempted > 0 ? (correct / attempted * 100).toFixed(1) : 0,
                subjects: subjectStats
            };
        }
        
        // Save to Firebase
        async function saveExamResults() {
            try {
                const results = calculateResults();
                examData.endTime = new Date().toISOString();
                
                const examResult = {
                    ...examData,
                    ...results,
                    submittedAt: new Date().toISOString(),
                    createdAt: examData.startTime
                };
                
                // Save to Firebase: /users/{email}/exams/{paperId}
                const db = firebase.firestore();
                
                await db.collection('users').doc(examData.email).collection('exams').doc(examData.examId).set(examResult);
                
                console.log('Exam results saved successfully');
                return examResult;
            } catch (error) {
                console.error('Error saving exam results:', error);
                throw error;
            }
        }
        
        // Handle exam submission
        async function handleExamSubmission() {
            try {
                // Show loading
                document.getElementById('confirmSubmit').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                document.getElementById('confirmSubmit').disabled = true;
                
                // Switch to portrait before submitting on mobile (iOS and Android)
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('portrait').catch(() => {});
                    } else if (screen.lockOrientation) {
                        screen.lockOrientation('portrait');
                    } else if (screen.mozLockOrientation) {
                        screen.mozLockOrientation('portrait');
                    } else if (screen.msLockOrientation) {
                        screen.msLockOrientation('portrait');
                    }
                }
                
                // Save results to Firebase
                const results = await saveExamResults();
                
                // Store results in sessionStorage for result page
                sessionStorage.setItem('examResults', JSON.stringify(results));
                
                // Redirect to result page
                window.location.href = 'result/result.html';
                
            } catch (error) {
                alert('Error submitting exam. Please try again.');
                document.getElementById('confirmSubmit').innerHTML = 'Submit';
                document.getElementById('confirmSubmit').disabled = false;
            }
        }
        
        // Function to toggle question type (MCQ or Numerical)
        function setQuestionType(type) {
            const mcqOptions = document.getElementById('mcqOptions');
            const numericalSection = document.getElementById('numericalSection');
            const virtualKeyboard = document.querySelector('.virtual-keyboard');
            
            if (type === 'numerical') {
                mcqOptions.style.display = 'none';
                numericalSection.style.display = 'block';
                virtualKeyboard.style.display = 'grid';
            } else { // 'mcq'
                mcqOptions.style.display = 'block';
                numericalSection.style.display = 'none';
                virtualKeyboard.style.display = 'none';
            }
        }
        
        // Function to check if current question needs on-screen keyboard
        function needsOnScreenKeyboard() {
            const questionNum = examData.currentQuestion;
            const questionData = questionsData[questionNum];
            return questionData && questionData.needsOnScreenKeyboard === 'yes';
        }
        
        // Hide view instructions on question area click
        function hideViewInstructions() {
            const viewInstructions = document.getElementById('viewInstructions');
            if (viewInstructions) {
                viewInstructions.style.display = 'none';
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeExam();
            
            // Hide view instructions when question area is clicked
            const questionArea = document.querySelector('.question-area');
            if (questionArea) {
                questionArea.addEventListener('click', hideViewInstructions);
            }
            
            // Mobile-specific initialization
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Add mobile class to body
                document.body.classList.add('mobile-device');
                
                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Handle orientation change
                window.addEventListener('orientationchange', function() {
                    setTimeout(function() {
                        // Recalculate layout after orientation change
                        window.scrollTo(0, 0);
                        
                        // Trigger resize event to adjust layouts
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                });
                
                // Improve touch scrolling
                document.body.style.webkitOverflowScrolling = 'touch';
            }
            
            // Handle submit button click
            document.getElementById('confirmSubmit').addEventListener('click', handleExamSubmission);
            
            // Set up on-screen keyboard functionality
            setupVirtualKeyboard();
            
            // Show numerical keyboard for testing
            examData.currentQuestion = 22;
            document.getElementById('mcqOptions').style.display = 'none';
            document.getElementById('numericalSection').style.display = 'block';
            
            // Function to set up the virtual keyboard
            function setupVirtualKeyboard() {
                const numericInput = document.getElementById('numerical-answer');
                const numKeys = document.querySelectorAll('.num-key');
                const backspace = document.getElementById('backspace');
                const clearAll = document.getElementById('clear-all');
                
                // Add touch and click handlers for number keys
                numKeys.forEach(key => {
                    // Prevent double-tap zoom
                    key.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                    }, {passive: false});
                    
                    key.addEventListener('click', function(e) {
                        e.preventDefault();
                        const value = this.getAttribute('data-value');
                        numericInput.value += value;
                        saveNumericalResponse();
                        
                        // Visual feedback
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 100);
                    });
                });
                
                // Add touch and click handler for backspace
                backspace.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                }, {passive: false});
                
                backspace.addEventListener('click', function(e) {
                    e.preventDefault();
                    numericInput.value = numericInput.value.slice(0, -1);
                    saveNumericalResponse();
                    
                    // Visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                });
                
                // Add touch and click handler for clear all
                clearAll.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                }, {passive: false});
                
                clearAll.addEventListener('click', function(e) {
                    e.preventDefault();
                    numericInput.value = '';
                    saveNumericalResponse();
                    
                    // Visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                });
                
                // Prevent native keyboard on mobile
                numericInput.addEventListener('focus', function() {
                    this.blur();
                });
                
                // Function to save the numerical response
                function saveNumericalResponse() {
                    const questionId = examData.currentQuestion;
                    const answer = numericInput.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    } else {
                        // If answer is cleared, save null
                        saveResponse(questionId, null, 30, true);
                    }
                }
            }
            
            // Add click handlers for section tabs
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // First handle the active tab UI
                    document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update display based on current question number
                    updateQuestionDisplay();
                });
            });
            
            // Add handlers for navigation buttons
            document.getElementById('prevQuestion').addEventListener('click', function() {
                // Your existing prev question logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            document.getElementById('nextQuestion').addEventListener('click', function() {
                // Save the current answer before moving to next question
                const questionId = examData.currentQuestion;
                
                // Check if current question needs keyboard
                if (needsOnScreenKeyboard()) {
                    const numericalAnswer = document.getElementById('numerical-answer').value;
                    if (numericalAnswer.trim() !== '') {
                        saveResponse(questionId, numericalAnswer, 30, true);
                        
                        // Update the question palette to show this question as answered
                        const questionBtn = document.querySelector(`.question-btn:nth-child(${questionId})`);
                        if (questionBtn) {
                            questionBtn.classList.remove('not-visited', 'not-answered');
                            questionBtn.classList.add('answered');
                        }
                    }
                }
                
                // Your existing next question logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            document.getElementById('markQuestion').addEventListener('click', function() {
                // Save the current answer and mark for review
                const questionId = examData.currentQuestion;
                
                // Check if current question needs keyboard
                if (needsOnScreenKeyboard()) {
                    const numericalAnswer = document.getElementById('numerical-answer').value;
                    if (numericalAnswer.trim() !== '') {
                        // Save response and mark for review
                        const response = saveResponse(questionId, numericalAnswer, 30, true);
                        if (response) response.isMarkedForReview = true;
                        
                        // Update the question palette to show this question as marked
                        const questionBtn = document.querySelector(`.question-btn:nth-child(${questionId})`);
                        if (questionBtn) {
                            questionBtn.classList.remove('not-visited', 'not-answered');
                            questionBtn.classList.add('answered-marked');
                        }
                    }
                }
                
                // Your existing mark for review logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            // Also hide on any interaction with question elements
            document.addEventListener('click', function(e) {
                if (e.target.closest('.question-area, .option, .virtual-keyboard')) {
                    hideViewInstructions();
                }
            });
            
            // Track question changes and responses
            document.addEventListener('change', function(e) {
                const questionId = examData.currentQuestion;
                
                // For MCQ options
                if (e.target.classList.contains('option-radio')) {
                    const answer = e.target.id.split('-')[1].toUpperCase();
                    saveResponse(questionId, answer, 30); // Mock time spent
                }
                
                // For numerical input
                if (e.target.id === 'numerical-answer') {
                    const answer = e.target.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    }
                }
            });
            
            // Also track input for numerical questions
            document.addEventListener('input', function(e) {
                if (e.target.id === 'numerical-answer') {
                    const questionId = examData.currentQuestion;
                    const answer = e.target.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    }
                }
            });
        });
    </script>
</body>
</html>