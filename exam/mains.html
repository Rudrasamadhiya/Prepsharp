<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>JEE Main 2024 27 Jan Shift 1 - PrepSharp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="exam-style.css">
    <style>
        /* Styles for numerical input */
        .numerical-input {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid rgba(79, 70, 229, 0.2);
        }
        
        .numerical-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .numerical-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4f46e5;
        }
        
        .numerical-textbox {
            padding: 12px 15px;
            border: 2px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .numerical-textbox:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        
        .numerical-instructions {
            font-size: 14px;
            color: #6b7280;
            background: rgba(79, 70, 229, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 3px solid #4f46e5;
        }
        
        .numerical-instructions p {
            margin: 5px 0;
        }
    </style>
</head>
<body onload="goFullScreen()">
    <div class="exam-container">
        <!-- Top strip with NTA logo and user info -->
        <div class="top-strip">
            <img src="../images/nta logo.png" alt="NTA Logo" class="nta-logo">
            <div class="top-right-user">
                <div class="candidate-avatar square" id="userInitials">JS</div>
                <div class="candidate-info-container">
                    <div><span class="candidate-label">Candidate Name:</span> <span id="userName">John Smith</span></div>
                    <div><span class="candidate-label">Candidate ID:</span> <span id="userId">JEE2024001234</span></div>
                    <div><span class="candidate-label">Time Remaining:</span> <span class="time-remaining" id="timeRemaining">02:59:45</span></div>
                </div>
            </div>
        </div>
        
        <!-- Purple strip with system and lab info -->
        <div class="purple-strip">
            <div>System No.: <span id="systemNo">C32</span></div>
            <div>Lab No.: <span id="labNo">LAB-A</span></div>
        </div>
        
        <!-- Black strip with paper indicator and buttons -->
        <div class="black-strip">
            <div class="paper-indicator"><span id="examType">Loading...</span> <span id="paperYear"></span> <span id="paperName">Loading...</span></div>
            <div class="strip-buttons">
                <div class="strip-btn" id="viewPaper">
                    <i class="fas fa-file-alt"></i> Question Paper
                </div>
                <div class="strip-btn" id="viewInstructions">
                    <i class="fas fa-info-circle"></i> View Instructions
                </div>
                <div class="strip-btn">
                    <i class="fas fa-clock"></i> <span id="timer">03:00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="main-content">
            <!-- Left container - Question display and its footer -->
            <div class="left-container">
                <!-- Left panel - Question display -->
                <div class="left-panel">
                    <!-- Section tabs strip -->
                    <div class="sections-strip" id="sectionsStrip">
                        <div class="section-tab active">Physics Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Physics Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Chemistry Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Chemistry Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Mathematics Section 1<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                        <div class="section-tab">Mathematics Section 2<span class="info-button" title="Section information"><i class="fas fa-info-circle"></i></span></div>
                    </div>
                    
                    <!-- Blue language strip -->
                    <div class="language-strip">
                        <div class="language-selector">
                            View in: 
                            <select id="languageSelector">
                                <option>English</option>
                                <option>Hindi</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Question area -->
                    <div class="question-area">
                        <!-- Watermark with grid layout -->
                        <div class="watermark">
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                            <div class="watermark-text">JEE2024001234</div>
                        </div>
                        
                        <div class="question-number" id="questionNumber">Question No. 3</div>
                        
                        <div class="question-content">
                            <div class="question-text" id="questionText">
                                <p>A particle of mass m is moving in a circular orbit of radius r under the influence of an attractive central force F = -kr where k is a positive constant. If the angular momentum of the particle is L, then the total energy of the particle is:</p>
                            </div>
                            
                            <div class="question-image" id="questionImage">
                                <img src="https://prepsharp.com/images/questions/physics1.png" alt="Question 1">
                            </div>
                            
                            <div class="options" id="optionsList">
                                <!-- For MCQ questions -->
                                <div class="mcq-options" id="mcqOptions">
                                    <div class="option">
                                        <input type="radio" name="q3" id="q3-a" class="option-radio">
                                        <label for="q3-a" class="option-label">
                                            <div class="option-letter">a)</div>
                                            <div class="option-text">L²/2mr² - kr²/2</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option">
                                        <input type="radio" name="q3" id="q3-b" class="option-radio">
                                        <label for="q3-b" class="option-label">
                                            <div class="option-letter">b)</div>
                                            <div class="option-text">L²/2mr² + kr²/2</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option">
                                        <input type="radio" name="q3" id="q3-c" class="option-radio">
                                        <label for="q3-c" class="option-label">
                                            <div class="option-letter">c)</div>
                                            <div class="option-text">L²/2mr² - kr²</div>
                                        </label>
                                    </div>
                                    
                                    <div class="option">
                                        <input type="radio" name="q3" id="q3-d" class="option-radio" checked>
                                        <label for="q3-d" class="option-label">
                                            <div class="option-letter">d)</div>
                                            <div class="option-text">L²/mr² - kr²/2</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Numerical Answer Section (for Section 2) -->
                            <div id="numericalSection" style="display: none; margin-top: 20px; background: #fffde7; border-radius: 12px; padding: 20px; border: 2px solid #f9a825; box-shadow: 0 4px 8px rgba(249, 168, 37, 0.15);">
                                <h3 style="margin-top: 0; color: #f9a825; font-size: 18px; text-align: center;">Numerical Answer</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="numerical-answer" style="display: block; margin-bottom: 8px; font-weight: 600; color: #f57f17;">Your Answer:</label>
                                    <input type="text" id="numerical-answer" style="width: 100%; padding: 12px; font-size: 18px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; background: white; box-shadow: 0 2px 6px rgba(249, 168, 37, 0.1);" readonly>
                                </div>
                                
                                <!-- On-screen keyboard -->
                                <div class="virtual-keyboard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; max-width: 300px; margin: 0 auto 15px;">
                                    <button class="num-key" data-value="1" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">1</button>
                                    <button class="num-key" data-value="2" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">2</button>
                                    <button class="num-key" data-value="3" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">3</button>
                                    <button class="num-key" data-value="+" style="padding: 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">+</button>
                                    <button class="num-key" data-value="4" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">4</button>
                                    <button class="num-key" data-value="5" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">5</button>
                                    <button class="num-key" data-value="6" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">6</button>
                                    <button class="num-key" data-value="-" style="padding: 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">-</button>
                                    <button class="num-key" data-value="7" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">7</button>
                                    <button class="num-key" data-value="8" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">8</button>
                                    <button class="num-key" data-value="9" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">9</button>
                                    <button class="num-key" data-value="." style="padding: 8px; font-size: 16px; background: #fffde7; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">.</button>
                                    <button class="num-key" data-value="0" style="padding: 8px; font-size: 16px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 2;">0</button>
                                    <button id="backspace" style="padding: 8px; font-size: 16px; background: #fff59d; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 2;"><i class="fas fa-backspace"></i></button>
                                    <button id="clear-all" style="padding: 8px; font-size: 16px; background: #ffee58; border: 1px solid #f0e68c; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; grid-column: span 4; margin-top: 6px;">Clear</button>
                                </div>
                                
                                <div style="background: #fff8e1; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 3px solid #ffca28;">
                                    <p style="margin: 0; font-size: 14px; color: #f57f17;"><strong>Instructions:</strong></p>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 14px; color: #795548;">
                                        <li>Enter your numerical answer using the keypad above</li>
                                        <li>Use decimal point (.) for decimal values if needed</li>
                                        <li>Use minus (-) for negative values if needed</li>
                                        <li>Use plus (+) for positive values if needed</li>
                                        <li>Do not include units in your answer</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Left footer with action buttons -->
                <div class="left-footer">
                    <button class="action-btn mark-btn" id="markQuestion">Mark for Review & Next</button>
                    <button class="action-btn clear-btn" id="clearResponse">Clear Response</button>
                    <button class="action-btn prev-btn" id="prevQuestion">Previous</button>
                    <button class="action-btn save-btn" id="nextQuestion">Save & Next</button>
                </div>
            </div>
            
            <!-- Right container - Navigation and its footer -->
            <div class="right-container">
                <!-- Right panel - Navigation -->
                <div class="right-panel">
                    <!-- Candidate info moved to top strip -->
                    
                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color answered"></div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-answered"></div>
                            <span>Not Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-visited"></div>
                            <span>Not Visited</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color marked"></div>
                            <span>Marked for Review</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color answered-marked"></div>
                            <span>Answered & Marked for Review</span>
                        </div>
                    </div>
                    
                    <!-- Section blue strip -->
                    <div class="section-strip" id="currentSection">
                        Physics Section 1
                    </div>
                    
                    <!-- Question palette -->
                    <div class="question-palette" id="questionPalette">
                        <!-- Chemistry Section 1: 20 questions (25-44) -->
                        <div class="question-btn answered">1</div>
                        <div class="question-btn answered">2</div>
                        <div class="question-btn not-answered active">3</div>
                        <div class="question-btn not-visited">4</div>
                        <div class="question-btn not-visited">5</div>
                        <div class="question-btn not-visited">6</div>
                        <div class="question-btn not-visited">7</div>
                        <div class="question-btn not-visited">8</div>
                        <div class="question-btn not-visited">9</div>
                        <div class="question-btn not-visited">10</div>
                        <div class="question-btn not-visited">11</div>
                        <div class="question-btn not-visited">12</div>
                        <div class="question-btn not-visited">13</div>
                        <div class="question-btn not-visited">14</div>
                        <div class="question-btn not-visited">15</div>
                        <div class="question-btn marked">16</div>
                        <div class="question-btn answered-marked">17</div>
                        <div class="question-btn not-visited">18</div>
                        <div class="question-btn not-visited">19</div>
                        <div class="question-btn not-visited">20</div>
                    </div>
                </div>
                
                <!-- Right footer with submit button -->
                <div class="right-footer">
                    <button class="action-btn submit-btn" id="submitExam">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Confirmation Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Submit Exam</h3>
                <button class="modal-close" id="closeSubmitModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your exam?</p>
                <p id="summaryText">You have answered <span id="answeredCount">0</span> out of <span id="totalCount">75</span> questions.</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancelSubmit">Cancel</button>
                <button class="action-btn submit-btn" id="confirmSubmit">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Full Screen Function -->
    <script>
        function goFullScreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) { // Firefox
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { // Chrome, Safari and Opera
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { // IE/Edge
                elem.msRequestFullscreen();
            }
            
            // Also try F11 key simulation
            try {
                const event = new KeyboardEvent('keydown', {
                    key: 'F11',
                    keyCode: 122,
                    which: 122,
                    code: 'F11',
                    bubbles: true
                });
                document.dispatchEvent(event);
            } catch (e) {
                console.log('F11 simulation failed:', e);
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="timer.js"></script>
    <script src="exam-script.js"></script>
    <script src="timer-integration.js"></script>
    <script src="section-info.js"></script>
    
    <script>
        // Exam tracking variables
        let examData = {
            studentId: '',
            studentName: '',
            email: '',
            examId: 'JEE_MAIN_2025_JAN_SHIFT1',
            examName: 'JEE Main Jan 2025 - Shift 1',
            examDate: new Date().toISOString().split('T')[0],
            startTime: new Date().toISOString(),
            endTime: null,
            totalDuration: 180,
            responses: {},
            questionTimes: {},
            subjectTimes: { physics: 0, chemistry: 0, mathematics: 0 },
            currentQuestion: 1,
            totalQuestions: 75
        };
        
        // Sample questions data (in real app, load from database)
        const questionsData = {
            1: { subject: 'physics', chapter: 'kinematics', correctAnswer: 'B', difficulty: 'easy', type: 'mcq', marks: 4 },
            2: { subject: 'physics', chapter: 'mechanics', correctAnswer: 'A', difficulty: 'moderate', type: 'mcq', marks: 4 },
            3: { subject: 'physics', chapter: 'thermodynamics', correctAnswer: 'C', difficulty: 'hard', type: 'mcq', marks: 4 },
            // Add more questions as needed
        };
        
        // Initialize exam data
        function initializeExam() {
            const loggedInUser = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                examData.email = userData.email;
                examData.studentName = userData.name || userData.email;
                examData.studentId = 'JEE2024' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                // Get exam ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('examId');
                if (examId) {
                    examData.examId = examId;
                    // Update exam name based on exam ID if needed
                    // This is a placeholder - you may want to fetch the actual name from your database
                    examData.examName = examId.replace(/_/g, ' ');
                }
                
                // Update UI
                document.getElementById('userName').textContent = examData.studentName;
                document.getElementById('userId').textContent = examData.studentId;
                
                // Update watermarks
                document.querySelectorAll('.watermark-text').forEach(el => {
                    el.textContent = examData.studentId;
                });
            }
        }
        
        // Track question response
        function saveResponse(questionId, answer, timeSpent, isNumerical = false) {
            const response = {
                questionId: questionId,
                userAnswer: answer,
                timeSpent: timeSpent,
                timestamp: new Date().toISOString(),
                isAttempted: answer !== null,
                isMarkedForReview: false,
                isNumerical: isNumerical
            };
            
            examData.responses[questionId] = response;
            return response;
        }
        
        // Update question display based on section type
        function updateQuestionDisplay() {
            const questionId = examData.currentQuestion;
            
            if (isCurrentSectionNumerical()) {
                setQuestionType('numerical');
                
                // Clear any selected MCQ options if switching to numerical
                document.querySelectorAll('.option-radio').forEach(radio => {
                    radio.checked = false;
                });
                
                // Load saved numerical answer if it exists
                const savedResponse = examData.responses[questionId];
                if (savedResponse && savedResponse.isNumerical) {
                    document.getElementById('numerical-answer').value = savedResponse.userAnswer || '';
                } else {
                    document.getElementById('numerical-answer').value = '';
                }
            } else {
                setQuestionType('mcq');
                
                // Clear numerical input
                document.getElementById('numerical-answer').value = '';
                
                // Load saved MCQ answer if it exists
                const savedResponse = examData.responses[questionId];
                if (savedResponse && !savedResponse.isNumerical && savedResponse.userAnswer) {
                    const radioId = `q${questionId}-${savedResponse.userAnswer.toLowerCase()}`;
                    const radioElement = document.getElementById(radioId);
                    if (radioElement) radioElement.checked = true;
                }
            }
        }
        
        // Calculate results
        function calculateResults() {
            let correct = 0, incorrect = 0, attempted = 0, unattempted = 0;
            let totalMarks = 0;
            let subjectStats = {
                physics: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 },
                chemistry: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 },
                mathematics: { correct: 0, incorrect: 0, attempted: 0, unattempted: 0, marks: 0 }
            };
            
            for (let i = 1; i <= examData.totalQuestions; i++) {
                const response = examData.responses[i];
                const question = questionsData[i];
                
                if (!question) continue;
                
                if (response && response.isAttempted) {
                    attempted++;
                    subjectStats[question.subject].attempted++;
                    
                    if (response.userAnswer === question.correctAnswer) {
                        correct++;
                        subjectStats[question.subject].correct++;
                        totalMarks += question.marks;
                        subjectStats[question.subject].marks += question.marks;
                    } else {
                        incorrect++;
                        subjectStats[question.subject].incorrect++;
                        // Negative marking: -1 for wrong answer
                        totalMarks -= 1;
                        subjectStats[question.subject].marks -= 1;
                    }
                } else {
                    unattempted++;
                    subjectStats[question.subject].unattempted++;
                }
            }
            
            return {
                totalQuestions: examData.totalQuestions,
                attempted,
                correct,
                incorrect,
                unattempted,
                totalMarks: Math.max(0, totalMarks),
                maxMarks: examData.totalQuestions * 4,
                accuracy: attempted > 0 ? (correct / attempted * 100).toFixed(1) : 0,
                subjects: subjectStats
            };
        }
        
        // Save to Firebase
        async function saveExamResults() {
            try {
                const results = calculateResults();
                examData.endTime = new Date().toISOString();
                
                const examResult = {
                    ...examData,
                    ...results,
                    submittedAt: new Date().toISOString(),
                    createdAt: examData.startTime
                };
                
                // Save to Firebase: /users/{email}/exams/{paperId}
                const db = firebase.firestore();
                
                await db.collection('users').doc(examData.email).collection('exams').doc(examData.examId).set(examResult);
                
                console.log('Exam results saved successfully');
                return examResult;
            } catch (error) {
                console.error('Error saving exam results:', error);
                throw error;
            }
        }
        
        // Handle exam submission
        async function handleExamSubmission() {
            try {
                // Show loading
                document.getElementById('confirmSubmit').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                document.getElementById('confirmSubmit').disabled = true;
                
                // Save results to Firebase
                const results = await saveExamResults();
                
                // Store results in sessionStorage for result page
                sessionStorage.setItem('examResults', JSON.stringify(results));
                
                // Redirect to result page
                window.location.href = 'result/result.html';
                
            } catch (error) {
                alert('Error submitting exam. Please try again.');
                document.getElementById('confirmSubmit').innerHTML = 'Submit';
                document.getElementById('confirmSubmit').disabled = false;
            }
        }
        
        // Function to toggle question type (MCQ or Numerical)
        function setQuestionType(type) {
            const mcqOptions = document.getElementById('mcqOptions');
            const numericalSection = document.getElementById('numericalSection');
            
            if (type === 'numerical') {
                mcqOptions.style.display = 'none';
                numericalSection.style.display = 'block';
            } else { // 'mcq'
                mcqOptions.style.display = 'block';
                numericalSection.style.display = 'none';
            }
        }
        
        // Function to check if current section is a Section 2 (numerical)
        function isCurrentSectionNumerical() {
            const currentSection = document.querySelector('.section-tab.active').textContent;
            return currentSection.includes('Section 2');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeExam();
            
            // Handle submit button click
            document.getElementById('confirmSubmit').addEventListener('click', handleExamSubmission);
            
            // Set up on-screen keyboard functionality
            setupVirtualKeyboard();
            
            // Force show numerical input for testing
            setQuestionType('numerical');
            
            // Uncomment this when done testing
            /*
            // Set initial question type based on current section
            if (isCurrentSectionNumerical()) {
                setQuestionType('numerical');
            } else {
                setQuestionType('mcq');
            }
            */
            
            // Function to set up the virtual keyboard
            function setupVirtualKeyboard() {
                const numericInput = document.getElementById('numerical-answer');
                const numKeys = document.querySelectorAll('.num-key');
                const backspace = document.getElementById('backspace');
                const clearAll = document.getElementById('clear-all');
                
                // Add click handlers for number keys
                numKeys.forEach(key => {
                    key.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        numericInput.value += value;
                        saveNumericalResponse();
                    });
                });
                
                // Add click handler for backspace
                backspace.addEventListener('click', function() {
                    numericInput.value = numericInput.value.slice(0, -1);
                    saveNumericalResponse();
                });
                
                // Add click handler for clear all
                clearAll.addEventListener('click', function() {
                    numericInput.value = '';
                    saveNumericalResponse();
                });
                
                // Function to save the numerical response
                function saveNumericalResponse() {
                    const questionId = examData.currentQuestion;
                    const answer = numericInput.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    } else {
                        // If answer is cleared, save null
                        saveResponse(questionId, null, 30, true);
                    }
                }
            }
            
            // Add click handlers for section tabs
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // First handle the active tab UI (this should be in your existing code)
                    document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update question display based on section
                    updateQuestionDisplay();
                });
            });
            
            // Add handlers for navigation buttons
            document.getElementById('prevQuestion').addEventListener('click', function() {
                // Your existing prev question logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            document.getElementById('nextQuestion').addEventListener('click', function() {
                // Save the current answer before moving to next question
                const questionId = examData.currentQuestion;
                
                // Check if we're in a numerical section
                if (isCurrentSectionNumerical()) {
                    const numericalAnswer = document.getElementById('numerical-answer').value;
                    if (numericalAnswer.trim() !== '') {
                        saveResponse(questionId, numericalAnswer, 30, true);
                        
                        // Update the question palette to show this question as answered
                        const questionBtn = document.querySelector(`.question-btn:nth-child(${questionId})`);
                        if (questionBtn) {
                            questionBtn.classList.remove('not-visited', 'not-answered');
                            questionBtn.classList.add('answered');
                        }
                    }
                }
                
                // Your existing next question logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            document.getElementById('markQuestion').addEventListener('click', function() {
                // Save the current answer and mark for review
                const questionId = examData.currentQuestion;
                
                // Check if we're in a numerical section
                if (isCurrentSectionNumerical()) {
                    const numericalAnswer = document.getElementById('numerical-answer').value;
                    if (numericalAnswer.trim() !== '') {
                        // Save response and mark for review
                        const response = saveResponse(questionId, numericalAnswer, 30, true);
                        if (response) response.isMarkedForReview = true;
                        
                        // Update the question palette to show this question as marked
                        const questionBtn = document.querySelector(`.question-btn:nth-child(${questionId})`);
                        if (questionBtn) {
                            questionBtn.classList.remove('not-visited', 'not-answered');
                            questionBtn.classList.add('answered-marked');
                        }
                    }
                }
                
                // Your existing mark for review logic would be here
                // After changing the question, update display:
                updateQuestionDisplay();
            });
            
            // Track question changes and responses
            document.addEventListener('change', function(e) {
                const questionId = examData.currentQuestion;
                
                // For MCQ options
                if (e.target.classList.contains('option-radio')) {
                    const answer = e.target.id.split('-')[1].toUpperCase();
                    saveResponse(questionId, answer, 30); // Mock time spent
                }
                
                // For numerical input
                if (e.target.id === 'numerical-answer') {
                    const answer = e.target.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    }
                }
            });
            
            // Also track input for numerical questions
            document.addEventListener('input', function(e) {
                if (e.target.id === 'numerical-answer') {
                    const questionId = examData.currentQuestion;
                    const answer = e.target.value;
                    if (answer.trim() !== '') {
                        saveResponse(questionId, answer, 30, true); // Mock time spent, mark as numerical
                    }
                }
            });
        });
    </script>
</body>
</html>